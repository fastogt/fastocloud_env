server {
  access_log /var/log/nginx/fastocloud_cods_84_access.log;
  error_log /var/log/nginx/fastocloud_cods_84_error.log;

  listen 84;
  listen [::]:84;

  server_name _;

  # Shared memory for touch file tracking
  lua_shared_dict touched_files 10m;

  # Initialize Lua functions
  init_by_lua_block {
    -- Function to extract stream ID from URI
    function extract_stream_id(uri)
      -- Match patterns like /stream123/segment001.ts
      local stream_id = string.match(uri, "^/([^/]+)/")
      return stream_id
    end
  }

  location = /status {
    stub_status;
  }

  location = /touched-files {
    content_by_lua_block {
      local touched = ngx.shared.touched_files
      local files = {}

      -- Get all keys from shared memory
      local keys = touched:get_keys(0)
      for _, key in ipairs(keys) do
        if string.sub(key, 1, 7) == "stream:" then
          local stream_id = string.sub(key, 8)  -- Remove "stream:" prefix
          local timestamp = touched:get(key)
          table.insert(files, {
            stream_id = stream_id,
            timestamp = timestamp
          })
        end
      end

      ngx.header.content_type = "application/json"
      ngx.say(cjson.encode(files))
    }
  }

  location / {
    # Track file access for touch notifications
    access_by_lua_block {
      local touched = ngx.shared.touched_files
      local uri = ngx.var.uri

      -- Extract stream ID from URI
      local stream_id = extract_stream_id(uri)
      if stream_id then
        -- Store touch with current timestamp (expire in 1 hour)
        touched:set("stream:" .. stream_id, ngx.time(), 3600)
      end
    }

    # Disable cache
    add_header Cache-Control no-cache;

    # CORS setup
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length';
    # allow CORS preflight requests
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header 'Content-Type' 'text/plain charset=UTF-8';
      add_header 'Content-Length' 0;
      return 204;
    }
    types {
      application/vnd.apple.mpegurl m3u8;
      video/mp2t ts;
    }

    alias /home/fastocloud/streamer/cods/;
  }
}
